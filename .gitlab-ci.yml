image: ubuntu:latest

variables:
  GCC_V: 9
  OMPI_ALLOW_RUN_AS_ROOT: 1
  OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1

before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client git -y )'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts
  - apt-get update
  - apt-get install -y make git
  - apt-get install --yes gcc gfortran g++
  - DEBIAN_FRONTEND=noninteractive apt-get install --yes openmpi-bin libopenmpi-dev

install:
  stage: build
  script:
    - ./Config.pl -compiler=gfortran -install -O0

# run tests using the binary built before
test:
  stage: test
  script:
    - ./Config.pl -compiler=gfortran -install -O0
    - make -j test_hallmhd